---
title: "Using the iso8601 functions"
author: "Colin Smith"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Data interoperability is improved by the adoption of standard date and time formats. To facilitate use of the ISO 8601 standard, we've developed functions for converting to a subset of ISO 8601 formats, for reporting ISO 8601 format specifiers, and for reading ISO 8601 into R as POSIXct and POSIXt. This vignette provides an overview of these functions, their capabilities, and limitations.

```{r instload dataCleanr, message=FALSE, warning=FALSE}
# Install and load dataCleanr
# devtools::install_github('clnsmth/dataCleanr')
library(dataCleanr)
```

## Conversion

`iso8601_convert` uses `lubridate::parse_datetime` to read date and time strings into R and then outputs ISO 8601 formatted strings of a precision matching that of inputs. For a full list of parsing arguments, see `iso8601_convert` documentation.

Converting dates represented by a single format is easy.

```{r one format, echo=TRUE, paged.print=TRUE}
# Example data in one format
head(data_iso8601$date)

# Convert
x <- iso8601_convert(x = data_iso8601$date, orders = 'mdy')
head(x)
```

Data containing more than one format requires a little more work.

```{r two formats, echo=TRUE, paged.print=TRUE}
# Example data in two formats
head(data_iso8601$date_2_formats)

# If we try converting with only the 'mdy' order we receive partially converted data and a warning
x <- iso8601_convert(x = data_iso8601$date_2_formats, orders = 'mdy')
x

# Use the NAs to identify the order of the non-parsed data
data_iso8601$date_2_formats[is.na(x)]

# Looks like 'dmy'. Add it to the list of orders and retry
iso8601_convert(x = data_iso8601$date_2_formats, orders = c('mdy', 'dmy'))

# Success!!!
```

Time zone offsets are added as a two digit hour with a '+' or '-' with respect to UTC.

```{r datetimes with offset, echo=TRUE, paged.print=TRUE}
# Example data with dates and times
head(data_iso8601$datetime)

# Convert
x <- iso8601_convert(x = data_iso8601$datetime, orders = 'mdy HMS', tz = '-05')
head(x)
```

Converting dates represented by several formats is a bit more involved. 

```{r converting many formats, echo=TRUE, paged.print=TRUE}
# Several date and time formats representing 2012-05-15T13:29:54
data_iso8601$datetime_mess

# Convert to ISO 8601
iso8601_convert(x = data_iso8601$datetime_mess, orders = c('ymd', 'mdy', 'dmy HMS'))
```

## Get the datetime format string

Automated extraction of metadata content from data entities streamlines data archiving tasks. Use `iso8601_get_format_string` to retrieve the date time format specifier (e.g. 'YYYY-MM-DD') from a vector of ISO 8601 strings created with `iso8601_convert`.

```{r format string, echo=TRUE, paged.print=TRUE}
# Create ISO 8601 datetime strings
data_converted <- iso8601_convert(x = data_iso8601$datetime, orders = 'mdy HMS', tz = '-05')
head(data_converted)

# Get the format string
iso8601_get_format_string(x = data_converted)
```

If more than one date time format exists, `iso8601_get_format_string` returns the mode.

```{r format string mode, echo=TRUE, paged.print=TRUE}

data_converted <- c(
  '2012-05-15T13:45:00',
  '2012-06-15T13:45:00',
  '2012-07-15T13:45:00',
  '2012-08-15T13:45',
  '2012-09-15T13:45',
  '2012-10-15T13'
)

iso8601_get_format_string(x = data_converted)
```

## Reading into R

Use `iso8601_read` to read ISO 8601 formatted dates and times into R as POSIXct POSIXt.

```{r read, echo=TRUE, paged.print=TRUE}
# Input data
data_converted <- iso8601_convert(x = data_iso8601$datetime, orders = 'mdy HMS', tz = '-05')
head(data_converted)

# Read data into R
x <- iso8601_read(x = data_converted)
head(x)
class(x)
```
